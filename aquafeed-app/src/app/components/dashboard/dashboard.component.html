<div class="dashboard-container">
  <!-- Header -->
  <header class="dashboard-header">
    <div class="header-content">
      <div class="welcome-section">
        <h1>{{ getGreeting() }}, {{ user?.name || 'Usuario' }}!</h1>
        <p>Panel de Control AquaFeed</p>
      </div>
      <div class="header-actions">
        <button class="refresh-btn" (click)="refreshData()" [disabled]="isLoading">
          <span class="icon" [class.spinning]="isLoading">ğŸ”„</span>
          Actualizar
        </button>
        <button class="logout-btn" (click)="logout()">
          <span class="icon">ğŸšª</span>
          Cerrar SesiÃ³n
        </button>
      </div>
    </div>
  </header>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="loading-spinner"></div>
    <p>Cargando datos del dashboard...</p>
  </div>

  <!-- Main Content -->
  <main *ngIf="!isLoading" class="dashboard-main">
    <!-- WebSocket Status -->
    <section class="websocket-status">
      <div class="status-indicator" [class.connected]="isWebSocketConnected" [class.disconnected]="!isWebSocketConnected">
        <span class="status-dot"></span>
        <span class="status-text">
          {{ isWebSocketConnected ? 'ğŸŸ¢ Datos en tiempo real activos' : 'ğŸ”´ Desconectado - Reconectando...' }}
        </span>
        <span class="last-update">Ãšltima actualizaciÃ³n: {{ formatTimestamp(lastUpdate.toISOString()) }}</span>
      </div>
    </section>

    <!-- Real-time Sensor Data -->
    <section class="sensors-section" *ngIf="getDeviceIds().length > 0">
      <h2>ğŸ“Š Datos de Sensores en Tiempo Real</h2>
      <div class="devices-grid">
        <div class="device-card" *ngFor="let deviceId of getDeviceIds()">
          <div class="device-header">
            <h3>ğŸ”§ Dispositivo #{{ deviceId }}</h3>
            <span class="device-badge">Activo</span>
          </div>

          <!-- Datos de Agua -->
          <div class="sensor-data" *ngIf="getWaterData(deviceId) as waterData">
            <h4>ğŸ’§ ParÃ¡metros del Agua</h4>
            <div class="sensor-readings">
              <div class="reading-item" *ngIf="waterData.tempAgua !== undefined">
                <span class="reading-label">ğŸŒ¡ï¸ Temperatura</span>
                <span class="reading-value" [class.recent]="isDataRecent(deviceId, 'agua')">
                  {{ waterData.tempAgua | number:'1.1-1' }}Â°C
                </span>
              </div>
              <div class="reading-item" *ngIf="waterData.ph !== undefined">
                <span class="reading-label">âš—ï¸ pH</span>
                <span class="reading-value" [class.recent]="isDataRecent(deviceId, 'agua')">
                  {{ waterData.ph | number:'1.2-2' }}
                </span>
              </div>
              <div class="reading-item" *ngIf="waterData.minerales !== undefined">
                <span class="reading-label">âš›ï¸ Minerales</span>
                <span class="reading-value" [class.recent]="isDataRecent(deviceId, 'agua')">
                  {{ waterData.minerales | number:'1.0-0' }}
                </span>
              </div>
            </div>
            <div class="timestamp">
              <small>Actualizado: {{ formatTimestamp(waterData.ts) }} (hace {{ getTimeSince(waterData.ts) }})</small>
            </div>
          </div>

          <!-- Datos de Ambiente -->
          <div class="sensor-data" *ngIf="getAmbientData(deviceId) as ambientData">
            <h4>ğŸŒ¡ï¸ ParÃ¡metros del Ambiente</h4>
            <div class="sensor-readings">
              <div class="reading-item" *ngIf="ambientData.tempAmb !== undefined">
                <span class="reading-label">ğŸŒ¡ï¸ Temperatura Ambiente</span>
                <span class="reading-value" [class.recent]="isDataRecent(deviceId, 'ambiente')">
                  {{ ambientData.tempAmb | number:'1.1-1' }}Â°C
                </span>
              </div>
              <div class="reading-item" *ngIf="ambientData.humAmb !== undefined">
                <span class="reading-label">ğŸ’§ Humedad Ambiente</span>
                <span class="reading-value" [class.recent]="isDataRecent(deviceId, 'ambiente')">
                  {{ ambientData.humAmb | number:'1.0-0' }}%
                </span>
              </div>
            </div>
            <div class="timestamp">
              <small>Actualizado: {{ formatTimestamp(ambientData.ts) }} (hace {{ getTimeSince(ambientData.ts) }})</small>
            </div>
          </div>

          <!-- No hay datos -->
          <div class="no-data" *ngIf="!getWaterData(deviceId) && !getAmbientData(deviceId)">
            <p>â³ Esperando datos del dispositivo...</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Mensaje cuando no hay dispositivos -->
    <section class="no-devices" *ngIf="getDeviceIds().length === 0">
      <div class="empty-state">
        <div class="empty-icon">ğŸ“¡</div>
        <h3>No hay dispositivos conectados</h3>
        <p>Los dispositivos aparecerÃ¡n aquÃ­ cuando comiencen a enviar datos.</p>
        <p class="help-text">AsegÃºrate de que tus dispositivos Arduino/ESP32 estÃ©n encendidos y conectados al servidor MQTT.</p>
      </div>
    </section>

    <!-- Stats Cards -->
    <section class="stats-section">
      <h2>EstadÃ­sticas del Sistema</h2>
      <div class="stats-grid">
        <div class="stat-card feeding-card">
          <div class="stat-icon">ğŸŸ</div>
          <div class="stat-content">
            <h3>Total de Alimentaciones</h3>
            <p class="stat-number">{{ dashboardData?.stats?.totalFeedings || 0 }}</p>
            <span class="stat-label">Alimentaciones registradas</span>
          </div>
        </div>

        <div class="stat-card devices-card">
          <div class="stat-icon">ğŸ“¡</div>
          <div class="stat-content">
            <h3>Dispositivos Activos</h3>
            <p class="stat-number">{{ dashboardData?.stats?.activeDevices || 0 }}</p>
            <span class="stat-label">Dispositivos conectados</span>
          </div>
        </div>

        <div class="stat-card update-card">
          <div class="stat-icon">â°</div>
          <div class="stat-content">
            <h3>Ãšltima ActualizaciÃ³n</h3>
            <p class="stat-time">{{ dashboardData?.stats?.lastUpdate | date:'short' }}</p>
            <span class="stat-label">Datos sincronizados</span>
          </div>
        </div>
      </div>
    </section>

    <!-- Quick Actions -->
    <section class="actions-section">
      <h2>Acciones RÃ¡pidas</h2>
      
      <!-- Mensaje de estado de alimentaciÃ³n -->
      <div class="feeding-status" *ngIf="feedingMessage">
        <p [class.success]="feedingMessage.includes('âœ…')" 
           [class.error]="feedingMessage.includes('âŒ')"
           [class.loading]="feedingMessage.includes('â³')">
          {{ feedingMessage }}
        </p>
      </div>

      <div class="actions-grid">
        <button class="action-card feed-button" 
                (click)="feedNow()" 
                [disabled]="isFeeding"
                [class.feeding]="isFeeding">
          <div class="action-icon">ğŸ½ï¸</div>
          <h3>{{ isFeeding ? 'Alimentando...' : 'Alimentar Ahora' }}</h3>
          <p>Ejecutar alimentaciÃ³n manual</p>
          <small *ngIf="user && user.deviceId">Dispositivo: #{{ user.deviceId }}</small>
        </button>

        <button class="action-card">
          <div class="action-icon">ğŸ“Š</div>
          <h3>Ver Reportes</h3>
          <p>Consultar historial de alimentaciones</p>
        </button>

        <button class="action-card">
          <div class="action-icon">âš™ï¸</div>
          <h3>Configurar Horarios</h3>
          <p>Programar alimentaciones automÃ¡ticas</p>
        </button>

        <button class="action-card">
          <div class="action-icon">ğŸ“±</div>
          <h3>Estado de Dispositivos</h3>
          <p>Monitorear dispositivos conectados</p>
        </button>
      </div>
    </section>

    <!-- Recent Activity -->
    <section class="activity-section">
      <h2>Actividad Reciente</h2>
      <div class="activity-list">
        <div class="activity-item">
          <div class="activity-icon">ğŸ½ï¸</div>
          <div class="activity-content">
            <h4>AlimentaciÃ³n AutomÃ¡tica</h4>
            <p>Tanque Principal - 15:30</p>
            <span class="activity-time">Hace 2 horas</span>
          </div>
        </div>

        <div class="activity-item">
          <div class="activity-icon">ğŸ“¡</div>
          <div class="activity-content">
            <h4>Dispositivo Conectado</h4>
            <p>Sensor de pH - Tanque 2</p>
            <span class="activity-time">Hace 4 horas</span>
          </div>
        </div>

        <div class="activity-item">
          <div class="activity-icon">âš™ï¸</div>
          <div class="activity-content">
            <h4>ConfiguraciÃ³n Actualizada</h4>
            <p>Horario de alimentaciÃ³n modificado</p>
            <span class="activity-time">Hace 6 horas</span>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- User Info Footer -->
  <footer class="dashboard-footer">
    <div class="user-info">
      <span class="user-details">
        <strong>{{ user?.name }}</strong> ({{ user?.username }}) - {{ user?.role === 'admin' ? 'Administrador' : 'Usuario' }}
      </span>
      <span class="user-email">{{ user?.email }}</span>
    </div>
  </footer>
</div>
